
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'preview-scripts/assets/Script/View/CellView.js';
                    var __require = nodeEnv ? function (request) {
                        return cc.require(request);
                    } : function (request) {
                        return __quick_compile_project__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_project__.registerModule(__filename, module);}"use strict";
cc._RF.push(module, 'fbf19Cx4ptFV62UZ7+qJJpQ', 'CellView');
// Script/View/CellView.js

"use strict";

var _ConstValue = require("../Model/ConstValue");

cc.Class({
  "extends": cc.Component,
  properties: {
    // foo: {
    //    default: null,      // The default value will be used only when the component attaching
    //                           to a node for the first time
    //    url: cc.Texture2D,  // optional, default is typeof default
    //    serializable: true, // optional, default is true
    //    visible: true,      // optional, default is true
    //    displayName: 'Foo', // optional
    //    readonly: false,    // optional, default is false
    // },
    // ...
    defaultFrame: {
      "default": null,
      type: cc.SpriteFrame
    }
  },
  // use this for initialization
  onLoad: function onLoad() {
    //this.model = null;
    this.isSelect = false;
  },
  initWithModel: function initWithModel(model) {
    this.model = model;
    var x = model.startX;
    var y = model.startY;
    this.node.x = _ConstValue.CELL_WIDTH * (x - 0.5);
    this.node.y = _ConstValue.CELL_HEIGHT * (y - 0.5);
    var animation = this.node.getComponent(cc.Animation);

    if (model.status == _ConstValue.CELL_STATUS.COMMON) {
      animation.stop();
    } else {
      animation.play(model.status);
    }
  },
  // 执行移动动作
  updateView: function updateView() {
    var _this = this;

    var cmd = this.model.cmd;

    if (cmd.length <= 0) {
      return;
    }

    var actionArray = [];
    var curTime = 0;

    for (var i in cmd) {
      if (cmd[i].playTime > curTime) {
        var delay = cc.delayTime(cmd[i].playTime - curTime);
        actionArray.push(delay);
      }

      if (cmd[i].action == "moveTo") {
        var x = (cmd[i].pos.x - 0.5) * _ConstValue.CELL_WIDTH;
        var y = (cmd[i].pos.y - 0.5) * _ConstValue.CELL_HEIGHT;
        var move = cc.moveTo(_ConstValue.ANITIME.TOUCH_MOVE, cc.v2(x, y));
        actionArray.push(move);
      } else if (cmd[i].action == "toDie") {
        if (this.status == _ConstValue.CELL_STATUS.BIRD) {
          var animation = this.node.getComponent(cc.Animation);
          animation.play("effect");
          actionArray.push(cc.delayTime(_ConstValue.ANITIME.BOMB_BIRD_DELAY));
        }

        var callFunc = cc.callFunc(function () {
          this.node.destroy();
        }, this);
        actionArray.push(callFunc);
      } else if (cmd[i].action == "setVisible") {
        (function () {
          var isVisible = cmd[i].isVisible;
          actionArray.push(cc.callFunc(function () {
            if (isVisible) {
              this.node.opacity = 255;
            } else {
              this.node.opacity = 0;
            }
          }, _this));
        })();
      } else if (cmd[i].action == "toShake") {
        var rotateRight = cc.rotateBy(0.06, 30);
        var rotateLeft = cc.rotateBy(0.12, -60);
        actionArray.push(cc.repeat(cc.sequence(rotateRight, rotateLeft, rotateRight), 2));
      }

      curTime = cmd[i].playTime + cmd[i].keepTime;
    }

    if (actionArray.length == 1) {
      this.node.runAction(actionArray[0]);
    } else {
      var _cc;

      this.node.runAction((_cc = cc).sequence.apply(_cc, actionArray));
    }
  },
  // called every frame, uncomment this function to activate update callback
  // update: function (dt) {
  // },
  setSelect: function setSelect(flag) {
    var animation = this.node.getComponent(cc.Animation);
    var bg = this.node.getChildByName("select");

    if (flag == false && this.isSelect && this.model.status == _ConstValue.CELL_STATUS.COMMON) {
      animation.stop();
      this.node.getComponent(cc.Sprite).spriteFrame = this.defaultFrame;
    } else if (flag && this.model.status == _ConstValue.CELL_STATUS.COMMON) {
      animation.play(_ConstValue.CELL_STATUS.CLICK);
    } else if (flag && this.model.status == _ConstValue.CELL_STATUS.BIRD) {
      animation.play(_ConstValue.CELL_STATUS.CLICK);
    }

    bg.active = flag;
    this.isSelect = flag;
  }
});

cc._RF.pop();
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_project__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFzc2V0cy9TY3JpcHQvVmlldy9DZWxsVmlldy5qcyJdLCJuYW1lcyI6WyJjYyIsIkNsYXNzIiwiQ29tcG9uZW50IiwicHJvcGVydGllcyIsImRlZmF1bHRGcmFtZSIsInR5cGUiLCJTcHJpdGVGcmFtZSIsIm9uTG9hZCIsImlzU2VsZWN0IiwiaW5pdFdpdGhNb2RlbCIsIm1vZGVsIiwieCIsInN0YXJ0WCIsInkiLCJzdGFydFkiLCJub2RlIiwiQ0VMTF9XSURUSCIsIkNFTExfSEVJR0hUIiwiYW5pbWF0aW9uIiwiZ2V0Q29tcG9uZW50IiwiQW5pbWF0aW9uIiwic3RhdHVzIiwiQ0VMTF9TVEFUVVMiLCJDT01NT04iLCJzdG9wIiwicGxheSIsInVwZGF0ZVZpZXciLCJjbWQiLCJsZW5ndGgiLCJhY3Rpb25BcnJheSIsImN1clRpbWUiLCJpIiwicGxheVRpbWUiLCJkZWxheSIsImRlbGF5VGltZSIsInB1c2giLCJhY3Rpb24iLCJwb3MiLCJtb3ZlIiwibW92ZVRvIiwiQU5JVElNRSIsIlRPVUNIX01PVkUiLCJ2MiIsIkJJUkQiLCJCT01CX0JJUkRfREVMQVkiLCJjYWxsRnVuYyIsImRlc3Ryb3kiLCJpc1Zpc2libGUiLCJvcGFjaXR5Iiwicm90YXRlUmlnaHQiLCJyb3RhdGVCeSIsInJvdGF0ZUxlZnQiLCJyZXBlYXQiLCJzZXF1ZW5jZSIsImtlZXBUaW1lIiwicnVuQWN0aW9uIiwic2V0U2VsZWN0IiwiZmxhZyIsImJnIiwiZ2V0Q2hpbGRCeU5hbWUiLCJTcHJpdGUiLCJzcHJpdGVGcmFtZSIsIkNMSUNLIiwiYWN0aXZlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUVBQSxFQUFFLENBQUNDLEtBQUgsQ0FBUztBQUNMLGFBQVNELEVBQUUsQ0FBQ0UsU0FEUDtBQUdMQyxFQUFBQSxVQUFVLEVBQUU7QUFDUjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBQyxJQUFBQSxZQUFZLEVBQUM7QUFD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WCxJQUFxQkMsd0JBQVlxQixJQUE1QyxFQUFpRDtBQUNsRHpCLE1BQUFBLFNBQVMsQ0FBQ08sSUFBVixDQUFlSCx3QkFBWXdDLEtBQTNCO0FBQ0g7O0FBQ0RKLElBQUFBLEVBQUUsQ0FBQ0ssTUFBSCxHQUFZTixJQUFaO0FBQ0EsU0FBS2pELFFBQUwsR0FBZ0JpRCxJQUFoQjtBQUNIO0FBbEhJLENBQVQiLCJzb3VyY2VSb290IjoiLyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q0VMTF9TVEFUVVMsIENFTExfV0lEVEgsIENFTExfSEVJR0hULCBBTklUSU1FfSBmcm9tICcuLi9Nb2RlbC9Db25zdFZhbHVlJztcblxuY2MuQ2xhc3Moe1xuICAgIGV4dGVuZHM6IGNjLkNvbXBvbmVudCxcblxuICAgIHByb3BlcnRpZXM6IHtcbiAgICAgICAgLy8gZm9vOiB7XG4gICAgICAgIC8vICAgIGRlZmF1bHQ6IG51bGwsICAgICAgLy8gVGhlIGRlZmF1bHQgdmFsdWUgd2lsbCBiZSB1c2VkIG9ubHkgd2hlbiB0aGUgY29tcG9uZW50IGF0dGFjaGluZ1xuICAgICAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvIGEgbm9kZSBmb3IgdGhlIGZpcnN0IHRpbWVcbiAgICAgICAgLy8gICAgdXJsOiBjYy5UZXh0dXJlMkQsICAvLyBvcHRpb25hbCwgZGVmYXVsdCBpcyB0eXBlb2YgZGVmYXVsdFxuICAgICAgICAvLyAgICBzZXJpYWxpemFibGU6IHRydWUsIC8vIG9wdGlvbmFsLCBkZWZhdWx0IGlzIHRydWVcbiAgICAgICAgLy8gICAgdmlzaWJsZTogdHJ1ZSwgICAgICAvLyBvcHRpb25hbCwgZGVmYXVsdCBpcyB0cnVlXG4gICAgICAgIC8vICAgIGRpc3BsYXlOYW1lOiAnRm9vJywgLy8gb3B0aW9uYWxcbiAgICAgICAgLy8gICAgcmVhZG9ubHk6IGZhbHNlLCAgICAvLyBvcHRpb25hbCwgZGVmYXVsdCBpcyBmYWxzZVxuICAgICAgICAvLyB9LFxuICAgICAgICAvLyAuLi5cbiAgICAgICAgZGVmYXVsdEZyYW1lOntcbiAgICAgICAgICAgIGRlZmF1bHQ6IG51bGwsXG4gICAgICAgICAgICB0eXBlOiBjYy5TcHJpdGVGcmFtZVxuICAgICAgICB9XG4gICAgfSxcblxuICAgIC8vIHVzZSB0aGlzIGZvciBpbml0aWFsaXphdGlvblxuICAgIG9uTG9hZDogZnVuY3Rpb24gKCkge1xuICAgICAgICAvL3RoaXMubW9kZWwgPSBudWxsO1xuICAgICAgICB0aGlzLmlzU2VsZWN0ID0gZmFsc2U7XG4gICAgfSxcbiAgICBpbml0V2l0aE1vZGVsOiBmdW5jdGlvbihtb2RlbCl7XG4gICAgICAgIHRoaXMubW9kZWwgPSBtb2RlbDtcbiAgICAgICAgdmFyIHggPSBtb2RlbC5zdGFydFg7XG4gICAgICAgIHZhciB5ID0gbW9kZWwuc3RhcnRZO1xuICAgICAgICB0aGlzLm5vZGUueCA9IENFTExfV0lEVEggKiAoeCAtIDAuNSk7XG4gICAgICAgIHRoaXMubm9kZS55ID0gQ0VMTF9IRUlHSFQgKiAoeSAtIDAuNSk7XG4gICAgICAgIHZhciBhbmltYXRpb24gID0gdGhpcy5ub2RlLmdldENvbXBvbmVudChjYy5BbmltYXRpb24pO1xuICAgICAgICBpZiAobW9kZWwuc3RhdHVzID09IENFTExfU1RBVFVTLkNPTU1PTil7XG4gICAgICAgICAgICBhbmltYXRpb24uc3RvcCgpO1xuICAgICAgICB9IFxuICAgICAgICBlbHNle1xuICAgICAgICAgICAgYW5pbWF0aW9uLnBsYXkobW9kZWwuc3RhdHVzKTtcbiAgICAgICAgfVxuICAgIH0sXG4gICAgLy8g5omn6KGM56e75Yqo5Yqo5L2cXG4gICAgdXBkYXRlVmlldzogZnVuY3Rpb24oKXtcbiAgICAgICAgdmFyIGNtZCA9IHRoaXMubW9kZWwuY21kO1xuICAgICAgICBpZihjbWQubGVuZ3RoIDw9IDApe1xuICAgICAgICAgICAgcmV0dXJuIDtcbiAgICAgICAgfVxuICAgICAgICB2YXIgYWN0aW9uQXJyYXkgPSBbXTtcbiAgICAgICAgdmFyIGN1clRpbWUgPSAwO1xuICAgICAgICBmb3IodmFyIGkgaW4gY21kKXtcbiAgICAgICAgICAgIGlmKCBjbWRbaV0ucGxheVRpbWUgPiBjdXJUaW1lKXtcbiAgICAgICAgICAgICAgICB2YXIgZGVsYXkgPSBjYy5kZWxheVRpbWUoY21kW2ldLnBsYXlUaW1lIC0gY3VyVGltZSk7XG4gICAgICAgICAgICAgICAgYWN0aW9uQXJyYXkucHVzaChkZWxheSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZihjbWRbaV0uYWN0aW9uID09IFwibW92ZVRvXCIpe1xuICAgICAgICAgICAgICAgIHZhciB4ID0gKGNtZFtpXS5wb3MueCAtIDAuNSkgKiBDRUxMX1dJRFRIO1xuICAgICAgICAgICAgICAgIHZhciB5ID0gKGNtZFtpXS5wb3MueSAtIDAuNSkgKiBDRUxMX0hFSUdIVDtcbiAgICAgICAgICAgICAgICB2YXIgbW92ZSA9IGNjLm1vdmVUbyhBTklUSU1FLlRPVUNIX01PVkUsIGNjLnYyKHgseSkpO1xuICAgICAgICAgICAgICAgIGFjdGlvbkFycmF5LnB1c2gobW92ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmKGNtZFtpXS5hY3Rpb24gPT0gXCJ0b0RpZVwiKXtcbiAgICAgICAgICAgICAgICBpZih0aGlzLnN0YXR1cyA9PSBDRUxMX1NUQVRVUy5CSVJEKXtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGFuaW1hdGlvbiA9IHRoaXMubm9kZS5nZXRDb21wb25lbnQoY2MuQW5pbWF0aW9uKTtcbiAgICAgICAgICAgICAgICAgICAgYW5pbWF0aW9uLnBsYXkoXCJlZmZlY3RcIik7XG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbkFycmF5LnB1c2goY2MuZGVsYXlUaW1lKEFOSVRJTUUuQk9NQl9CSVJEX0RFTEFZKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhciBjYWxsRnVuYyA9IGNjLmNhbGxGdW5jKGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubm9kZS5kZXN0cm95KCk7XG4gICAgICAgICAgICAgICAgfSx0aGlzKTtcbiAgICAgICAgICAgICAgICBhY3Rpb25BcnJheS5wdXNoKGNhbGxGdW5jKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYoY21kW2ldLmFjdGlvbiA9PSBcInNldFZpc2libGVcIil7XG4gICAgICAgICAgICAgICAgbGV0IGlzVmlzaWJsZSA9IGNtZFtpXS5pc1Zpc2libGU7XG4gICAgICAgICAgICAgICAgYWN0aW9uQXJyYXkucHVzaChjYy5jYWxsRnVuYyhmdW5jdGlvbigpe1xuICAgICAgICAgICAgICAgICAgICBpZihpc1Zpc2libGUpe1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5ub2RlLm9wYWNpdHkgPSAyNTU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZXtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubm9kZS5vcGFjaXR5ID0gMDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sdGhpcykpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZihjbWRbaV0uYWN0aW9uID09IFwidG9TaGFrZVwiKXtcbiAgICAgICAgICAgICAgICBsZXQgcm90YXRlUmlnaHQgPSBjYy5yb3RhdGVCeSgwLjA2LDMwKTtcbiAgICAgICAgICAgICAgICBsZXQgcm90YXRlTGVmdCA9IGNjLnJvdGF0ZUJ5KDAuMTIsIC02MCk7XG4gICAgICAgICAgICAgICAgYWN0aW9uQXJyYXkucHVzaChjYy5yZXBlYXQoY2Muc2VxdWVuY2Uocm90YXRlUmlnaHQsIHJvdGF0ZUxlZnQsIHJvdGF0ZVJpZ2h0KSwgMikpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY3VyVGltZSA9IGNtZFtpXS5wbGF5VGltZSArIGNtZFtpXS5rZWVwVGltZTtcbiAgICAgICAgfVxuICAgICAgICBpZihhY3Rpb25BcnJheS5sZW5ndGggPT0gMSl7XG4gICAgICAgICAgICB0aGlzLm5vZGUucnVuQWN0aW9uKGFjdGlvbkFycmF5WzBdKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNle1xuICAgICAgICAgICAgdGhpcy5ub2RlLnJ1bkFjdGlvbihjYy5zZXF1ZW5jZSguLi5hY3Rpb25BcnJheSkpO1xuICAgICAgICB9XG5cbiAgICB9LFxuICAgIC8vIGNhbGxlZCBldmVyeSBmcmFtZSwgdW5jb21tZW50IHRoaXMgZnVuY3Rpb24gdG8gYWN0aXZhdGUgdXBkYXRlIGNhbGxiYWNrXG4gICAgLy8gdXBkYXRlOiBmdW5jdGlvbiAoZHQpIHtcblxuICAgIC8vIH0sXG4gICAgc2V0U2VsZWN0OiBmdW5jdGlvbihmbGFnKXtcbiAgICAgICAgdmFyIGFuaW1hdGlvbiA9IHRoaXMubm9kZS5nZXRDb21wb25lbnQoY2MuQW5pbWF0aW9uKTtcbiAgICAgICAgdmFyIGJnID0gdGhpcy5ub2RlLmdldENoaWxkQnlOYW1lKFwic2VsZWN0XCIpO1xuICAgICAgICBpZihmbGFnID09IGZhbHNlICYmIHRoaXMuaXNTZWxlY3QgJiYgdGhpcy5tb2RlbC5zdGF0dXMgPT0gQ0VMTF9TVEFUVVMuQ09NTU9OKXtcbiAgICAgICAgICAgIGFuaW1hdGlvbi5zdG9wKCk7XG4gICAgICAgICAgICB0aGlzLm5vZGUuZ2V0Q29tcG9uZW50KGNjLlNwcml0ZSkuc3ByaXRlRnJhbWUgPSB0aGlzLmRlZmF1bHRGcmFtZTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmKGZsYWcgJiYgdGhpcy5tb2RlbC5zdGF0dXMgPT0gQ0VMTF9TVEFUVVMuQ09NTU9OKXtcbiAgICAgICAgICAgIGFuaW1hdGlvbi5wbGF5KENFTExfU1RBVFVTLkNMSUNLKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmKGZsYWcgJiYgdGhpcy5tb2RlbC5zdGF0dXMgPT0gQ0VMTF9TVEFUVVMuQklSRCl7XG4gICAgICAgICAgICBhbmltYXRpb24ucGxheShDRUxMX1NUQVRVUy5DTElDSyk7XG4gICAgICAgIH1cbiAgICAgICAgYmcuYWN0aXZlID0gZmxhZzsgXG4gICAgICAgIHRoaXMuaXNTZWxlY3QgPSBmbGFnO1xuICAgIH1cbn0pO1xuIl19